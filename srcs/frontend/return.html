<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login Return</title>
</head>
<body>
<script>

async function getCSRFCookie() {
  const csrfCookieName = 'csrftoken'; 
  const csrfCookie = getCookie(csrfCookieName);
  
  if (!csrfCookie) {
      try {
          const response = await fetch('/api/get-csrf-token/', {
              method: 'GET',
              credentials: 'same-origin'
          });
          if (!response.ok) {
              throw new Error('Failed to fetch CSRF token');
          }
          const data = await response.json();
          const csrfToken = data.csrfToken;
          if (csrfToken) {
              document.cookie = `${csrfCookieName}=${csrfToken}; path=/`;
              return csrfToken;
          }
      } catch (error) {
          console.error('Error fetching CSRF token:', error);
          return null;
      }
  } else {
      return csrfCookie;
  }
}


function getCookie(name) {
  const cookies = document.cookie.split(';');
  for (let cookie of cookies) {
      const [cookieName, cookieValue] = cookie.trim().split('=');
      if (cookieName === name) {
          return cookieValue;
      }
  }
  return null;
}


document.addEventListener("DOMContentLoaded", async function() {
  const locationSearch = window.location.search;
  const params = new URLSearchParams(locationSearch);
  const code = params.get('code');
  const jwtToken = params.get('jwtToken');
  const csrfToken = await getCSRFCookie();
  
  if (jwtToken) {
    localStorage.setItem("jwtToken", jwtToken); // Fixed typo here
  }
  
  if (code) {
    try {
      let fetchUrl = `/api/userinfo/?code=${code}`;
      

      const response = await fetch(fetchUrl, {
        headers: {
          'Authorization': `Bearer ${jwtToken}`,
          'X-CSRFToken': csrfToken
        }
    });

      if (!response.ok) {
        throw new Error('Failed to fetch user data');
      }
      const responseData = await response.json();
      const userData = responseData.user; 

      localStorage.setItem("isLoggedIn", true);
      localStorage.setItem("userLogin", userData.login);

      setTimeout(() => {
        window.location.href = "/";
    }, 1000);
    } catch (error) {
      console.error("Error fetching user info:", error);
    }
  }
});

</script>
</body>
</html>
